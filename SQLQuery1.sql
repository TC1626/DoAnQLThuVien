
CREATE DATABASE QL_THUVIEN
create TABLE DANGNHAP
(
 TENTK VARCHAR(50) primary key,
 PASS VARCHAR(50)
)
CREATE TABLE TACGIA
(
 MATG CHAR(10) PRIMARY KEY NOT NULL,
 TENTG NVARCHAR(50),
 PHAI NVARCHAR(10)
)

CREATE TABLE SACH
(
  MASH CHAR(10) PRIMARY KEY NOT NULL,
  TENSH NVARCHAR(50),
  THELOAI NVARCHAR(50),
  MATG CHAR(10) NOT NULL,
  SOLUONG INT,
  TINHTRANG NVARCHAR(10),
  CONSTRAINT FK_SACH_MATG FOREIGN KEY(MATG) REFERENCES TACGIA(MATG)
)
CREATE TABLE DOCGIA
(
 MADG CHAR(10) PRIMARY KEY NOT NULL,
 TENDG NVARCHAR(50),
 DIAC NVARCHAR(50),
 EMAIL VARCHAR(50),
 SDT CHAR(12),
)
CREATE TABLE NHANVIEN
(
 MANV CHAR(10) PRIMARY KEY NOT NULL,
 TENNV NVARCHAR(50),
 PHAI NVARCHAR(10),
 SDT CHAR(12)
)
CREATE TABLE MUONSACH
(
 MAPHIEU CHAR(10)PRIMARY KEY NOT NULL ,
 MADG CHAR(10)NOT NULL,
 MASH CHAR(10)NOT NULL,
 MANV CHAR(10)NOT NULL,
 NGAYMUON DATE,
 NGAYTRA DATE
 CONSTRAINT FK_MUONSACH_MADG FOREIGN KEY(MADG) REFERENCES DOCGIA(MADG),
 CONSTRAINT FK_MUONSACH_MASH FOREIGN KEY(MASH) REFERENCES SACH(MASH),
 CONSTRAINT FK_MUONSACH_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV),
)
CREATE TABLE CHITIETMUONSACH
(
 MACT CHAR(10)NOT NULL PRIMARY KEY ,
 MADG CHAR(10)NOT NULL,
 MASH CHAR(10)NOT NULL,
 NGAYTRASH DATE,
 GHICHU NVARCHAR(50),
 CONSTRAINT FK_CHITIETMUONSACH_MADG FOREIGN KEY(MADG) REFERENCES DOCGIA(MADG),
 CONSTRAINT FK_CHITIETMUONSACH_MASH FOREIGN KEY(MASH) REFERENCES SACH(MASH),
)

set dateformat dmy
INSERT INTO DANGNHAP VALUES('BAODEPTRAI','123'),
('DATXAUTRAI','123'),
('DA','123')
INSERT INTO TACGIA VALUES('TG01',N'PHAM GIA BAO','NAM'),
                         ('TG02',N'PHAM GIA DAT','NU')

INSERT INTO SACH(MASH,TENSH,THELOAI,MATG,SOLUONG) VALUES('SH01',N'GIAO DUC CONG DAN',N'GIAO DUC','TG01',20),
('SH02',N'SIEU NHAN SAM SET',N'THIEU NHI','TG02',30)

INSERT INTO DOCGIA VALUES('DG01','NHAT BAT QUAN','TAY NINH','NBQCC@gmail.com','0999999999'),
('DG02','DOAN CHI BINH','NUI VO DANG','CRCOLONG@gmail.com','088888888')

INSERT INTO NHANVIEN VALUES('NV01','LENH HO XUNG','NAM','077777777'),
('NV02','DUONG QUA','NAM','0666666666')

INSERT INTO MUONSACH VALUES('MP08','DG01','SH01','NV01','2/1/2020','3/2/2030'),
('MP02','DG02','SH02','NV02','10/1/2020','14/1/2020')

INSERT INTO CHITIETMUONSACH(MACT,MADG,MASH) VALUES('MP01','DG01','SH01'),
('MP02','DG02','SH02')

select DATEDIFF(DAY,NGAYTRA,GETDATE()) from MUONSACH where MAPHIEU='MP08'


	

SELECT * FROM TacGia
SELECT * FROM SACH
SELECT * FROM DOCGIA
SELECT * FROM NHANVIEN
SELECT * FROM MUONSACH
SELECT * FROM CHITIETMUONSACH
set dateformat dmy
INSERT INTO TACGIA VALUES('TG03',N'PHAM GIA BAO','NAM')
--------------======TRIGGER========------------
--------=======KT GHICHU====-------
	--DROP TRIGGER TK_GHICHU
	--GO 
	--ALTER TRIGGER TK_GHICHU ON CHITIETMUONSACH
	--FOR INSERT,UPDATE
	--AS
	--BEGIN
	--IF(SELECT NGAYTRASH FROM MUONSACH,inserted WHERE MUONSACH.MAPHIEU=inserted.MACT AND MUONSACH.MADG=inserted.MADG AND MUONSACH.MASH=inserted.MASH)<=(SELECT NGAYTRA FROM MUONSACH,inserted WHERE MUONSACH.MAPHIEU=inserted.MACT AND MUONSACH.MADG=inserted.MADG AND MUONSACH.MASH=inserted.MASH)
	--BEGIN
	--	UPDATE CHITIETMUONSACH
	--	SET GHICHU=N'ĐÚNG HẠNG'
	--	FROM MUONSACH,inserted
	--	WHERE MUONSACH.MAPHIEU=inserted.MACT AND MUONSACH.MADG=inserted.MADG AND MUONSACH.MASH=inserted.MASH
	--END
	--ELSE
	--	UPDATE CHITIETMUONSACH
	--	SET GHICHU=N'TRỄ HẠNG HẠNG'
	--	FROM MUONSACH,inserted
	--	WHERE MUONSACH.MAPHIEU=inserted.MACT AND MUONSACH.MADG=inserted.MADG AND MUONSACH.MASH=inserted.MASH
	--END

	--SELECT * FROM SACH
	--SELECT * FROM CHITIETMUONSACH
	--SELECT * FROM MUONSACH

	--EXEC TRASACH 'MP09','DG01','SH01','3/2/2020','CCC'
	--INSERT INTO MUONSACH VALUES('MP09','DG01','SH01','NV01','2/1/2020','3/2/2020')
--------=======KT TINHTRANG====-------
GO
CREATE TRIGGER KT_TTSH ON SACH
FOR INSERT, UPDATE
AS
begin
 IF(SELECT SOLUONG FROM inserted)>0
    UPDATE SACH
	SET TINHTRANG=N'Còn'
	FROM SACH
	JOIN inserted ON SACH.MASH=inserted.MASH
 else if(SELECT SOLUONG FROM inserted)<=0
    UPDATE SACH
	SET TINHTRANG=N'Hết'
	FROM SACH
	JOIN inserted ON SACH.MASH=inserted.MASH
end



--------=======KT THOIGIAN BANG MUONSACH====-------

GO 
CREATE TRIGGER TK_NGAY_MUON_TRA ON MUONSACH
FOR INSERT,UPDATE
AS
 IF(SELECT NGAYTRA FROM inserted)>=(SELECT NGAYMUON FROM inserted)
 COMMIT TRAN
 ELSE
  BEGIN
   PRINT 'NGAY MUON PHAI LON HON NGAY TRA'
   ROLLBACK TRAN
  END
-----------------======================IN RA==================-------------

-------------======IN TACGIA======-----------
GO
CREATE PROC INTACGIA
AS
 BEGIN
  SELECT * FROM TACGIA
 END

----

---------======IN SACH======-----------
GO
CREATE PROC INSACH
AS
 BEGIN
  SELECT * FROM SACH
 END



-------------======IN DOCGIA======-----------
GO
CREATE PROC INDOCGIA
AS
 BEGIN
  SELECT * FROM DOCGIA
 END



-------------======IN NHANVIEN======-----------
GO
CREATE PROC INNHANVIEN
AS
 BEGIN
  SELECT * FROM NHANVIEN
 END



-------------======IN MUONSACH======-----------
GO
CREATE PROC INMUONSACH
AS
 BEGIN
  SELECT * FROM MUONSACH
 END


-------------======IN CHITIETMUONSACH======-----------
GO
CREATE PROC INCHITIETMUONSACH
AS
 BEGIN
  SELECT * FROM CHITIETMUONSACH
 END



-----------------======================XOA==================-------------

-------------======XOA TACGIA======-----------
GO
CREATE PROC XOATACGIA @MTG CHAR(10)
AS
 BEGIN
  DELETE FROM TACGIA WHERE MATG=@MTG
 END



-------------======XOA SACH======-----------
GO
CREATE PROC XOASACH @MSH CHAR(10)
AS
 BEGIN
  DELETE FROM SACH WHERE MASH=@MSH
 END



-------------======XOA DOCGIA======-----------
GO
CREATE PROC XOADOCGIA @MDG CHAR(10)
AS
 BEGIN
  DELETE FROM DOCGIA WHERE MADG=@MDG
 END



-------------======XOA NHANVIEN======-----------
GO
CREATE PROC XOANHANVIEN @MNV CHAR(10)
AS
 BEGIN
  DELETE FROM NHANVIEN WHERE MANV=@MNV
 END



-------------======XOA MUONSACH======-----------
GO
CREATE PROC XOAMUONSACH @MP CHAR(10)
AS
 BEGIN
  DELETE FROM MUONSACH WHERE MAPHIEU=@MP
 END


-------------======XOA CHITIETMUONSACH======-----------
GO
CREATE PROC XOACHITIETMUONSACH @MCT CHAR(10)
AS
 BEGIN
  DELETE FROM CHITIETMUONSACH WHERE MACT=@MCT
 END



-----------------======================THEM==================-------------

-------------======THEM TACGIA======-----------
GO
CREATE PROC THEMTACGIA @MTG CHAR(10),@TTG NVARCHAR(50),@P NVARCHAR(10)
AS
 BEGIN
  INSERT INTO TACGIA VALUES(@MTG,@TTG,@P)
 END




-------------======THEM SACH======-----------
GO
CREATE PROC THEMSACH @MSH CHAR(10),@TS NVARCHAR(50),@L NVARCHAR(50),@MTG CHAR(10),@SL INT,@TT NVARCHAR(10)
AS
 BEGIN
  INSERT INTO SACH VALUES(@MSH,@TS,@L,@MTG,@SL,@TT)
 END



-------------======THEM DOCGIA======-----------
GO
CREATE PROC THEMDOCGIA @MDG CHAR(10),@TDG NVARCHAR(50),@DC NVARCHAR(50),@E VARCHAR(50),@SDT CHAR(12)
AS
 BEGIN
  INSERT INTO DOCGIA VALUES(@MDG,@TDG,@DC,@E,@SDT)
 END



-------------======THEM NHANVIEN======-----------
GO
CREATE PROC THEMNHANVIEN @MNV CHAR(10),@TNV NVARCHAR(50),@P NVARCHAR(10),@SDT CHAR(12)
AS
 BEGIN
  INSERT INTO NHANVIEN VALUES(@MNV,@TNV,@P,@SDT)
 END



-------------======THEM MUONSACH======-----------
GO
CREATE PROC THEMMUONSACH @MP CHAR(10), @MDG CHAR(10),@MSH CHAR(10),@MNV CHAR(10),@NM DATE,@NT DATE
AS
 BEGIN
 IF(SELECT SOLUONG FROM SACH WHERE MASH=@MSH)>0
   BEGIN
   INSERT INTO MUONSACH VALUES(@MP,@MDG,@MSH,@MNV,@NM,@NT)

   UPDATE SACH
   SET SOLUONG=SOLUONG-1
   WHERE MASH=@MSH
   END
 ELSE
    PRINT' HET SACH'
 END




-----------------======================sua==================-------------

-------------=======SUA TACGIA======-----------
GO
CREATE PROC SUATACGIA @MTG CHAR(10),@TTG NVARCHAR(50),@P NVARCHAR(10)
AS
 BEGIN
  
  UPDATE TACGIA
  SET TENTG=@TTG,PHAI=@P
  WHERE MATG=@MTG
 END


--TACGIA('MATG',TENTG,NGAYSINH,PHAI)
--SACH('MASH',TENSH,THELOAI,'MATG',SOLUONG,TINHTRANG)
--DOCGIA('MADG',TENDG,DIAC,EMAIL,SDT)
--NHANVIEN('MANV',TENNV,NGAYSINH,PHAI,SDT)
--MUONSACH(MAPHIEU,'MADG','MASH','MANV',NGAYMUON,NGAYTRA)
--CHITIETMUONSACH(MAPHIEU,'MADG','MASH',NGAYTRASH,GHICHU)
select * from MUONSACH
-------------======SUA SACH======-----------
GO
CREATE PROC SUASACH @MSH CHAR(10),@TS NVARCHAR(50),@L NVARCHAR(50),@MTG CHAR(10),@SL INT,@TT NVARCHAR(10)
AS
 BEGIN
  UPDATE SACH
  SET TENSH=@TS,THELOAI=@L,MATG=@MTG,SOLUONG=@SL,TINHTRANG=@TT
  WHERE MASH=@MSH
 END



-------------======SUA DOCGIA======-----------
GO
CREATE PROC SUADOCGIA @MDG CHAR(10),@TDG NVARCHAR(50),@DC NVARCHAR(50),@E VARCHAR(50),@SDT CHAR(12)
AS
 BEGIN
  UPDATE DOCGIA
  SET TENDG=@TDG,DIAC=@DC,EMAIL=@E,SDT=@SDT
  WHERE MADG=@MDG
 END



-------------======SUA NHANVIEN======-----------
GO
CREATE PROC SUANHANVIEN @MNV CHAR(10),@TNV NVARCHAR(50),@P NVARCHAR(10),@SDT CHAR(12)
AS
 BEGIN
  UPDATE NHANVIEN
  SET TENNV=@TNV,PHAI=@P,SDT=@SDT
  WHERE MANV=@MNV
 END



-------------======SUA MUONSACH======-----------
GO
CREATE PROC SUAMUONSACH @MP CHAR(10),@MDG CHAR(10),@MSH CHAR(10),@MNV CHAR(10),@NM DATE,@NT DATE
AS
 BEGIN
  UPDATE MUONSACH
  SET NGAYMUON=@NM,NGAYTRA=@NT,MADG=@MDG,MASH=@MSH,MANV=@MNV
  WHERE MAPHIEU=@MP
 END


-------------======SUA ChiTietMuonSach======-----------
GO
CREATE PROC SUACHITIETMUONSACH @MCT CHAR(10),@MDG CHAR(10),@MSH CHAR(10),@NTS DATE,@GC NVARCHAR(50)
AS
 BEGIN
  UPDATE CHITIETMUONSACH
  SET NGAYTRASH=@NTS,MADG=@MDG,MASH=@MSH,GHICHU=@GC
  WHERE MACT=@MCT
 END


---------------------------------------========TIM KIEM=======----------------------------
-------------=======TIM TACGIA======-----------
GO
CREATE PROC TIMTACGIA @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM TACGIA WHERE (MATG LIKE @TK) OR (TENTG LIKE @TK) OR ( PHAI LIKE @TK)
 END




-------------======TIM SACH======-----------
GO
CREATE PROC TIMSACH @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM SACH WHERE (MASH LIKE @TK) OR (TENSH LIKE @TK) OR (THELOAI LIKE @TK) OR( MATG LIKE @TK) OR (SOLUONG LIKE @TK) OR( TINHTRANG LIKE @TK)
 END



-------------======TIM DOCGIA======-----------
GO
CREATE PROC TIMDOCGIA @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM DOCGIA WHERE (MADG LIKE @TK) OR (TENDG LIKE @TK) OR (DIAC LIKE @TK) 
  OR( EMAIL LIKE @TK) OR (SDT LIKE @TK) 
 END


--TACGIA('MATG',TENTG,NGAYSINH,PHAI)
--SACH('MASH',TENSH,THELOAI,'MATG',SOLUONG,TINHTRANG)
--DOCGIA('MADG',TENDG,DIAC,EMAIL,SDT)
--NHANVIEN('MANV',TENNV,NGAYSINH,PHAI,SDT)
--MUONSACH('MADG','MASH','MANV',NGAYMUON,NGAYTRA)
-------------======TIM NHANVIEN======-----------
GO
CREATE PROC TIMNHANVIEN @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM NHANVIEN WHERE (MANV LIKE @TK) OR (TENNV LIKE @TK) 
  OR( PHAI LIKE @TK) OR (SDT LIKE @TK)
 END



-------------======TIM MUONSACH======-----------
GO
CREATE PROC TIMMUONSACH @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM MUONSACH WHERE (MADG LIKE @TK) OR (MANV LIKE @TK) OR (MASH LIKE @TK) 
  OR( NGAYMUON LIKE @TK) OR (NGAYTRA LIKE @TK) OR (MAPHIEU LIKE @TK)
 END


-------------======TIM CHITIETMUONSACH======-----------
GO
CREATE PROC TIMCHITIETMUONSACH @TK NVARCHAR(50)=NULL
AS
 BEGIN
  SELECT * FROM CHITIETMUONSACH WHERE (MADG LIKE @TK) OR (MACT LIKE @TK) OR (MASH LIKE @TK) 
  OR( NGAYTRASH LIKE @TK) OR (GHICHU LIKE @TK) 
 END



-------=================================KT NUT TRA SACH===========-----------
GO 
CREATE PROC TRASACH @MCT CHAR(10),@MDG CHAR(10),@MS CHAR(10),@NTS DATE=NULL,@GC NVARCHAR(50)=NULL
AS
  BEGIN
   IF(select DATEDIFF(DAY,NGAYTRA,GETDATE()) from MUONSACH where MAPHIEU=@MCT)<=0
   BEGIN

   INSERT INTO CHITIETMUONSACH VALUES(@MCT,@MDG,@MS,@NTS,@GC)
  
   UPDATE SACH
   SET SOLUONG=SOLUONG+1
   WHERE MASH=@MS
   

   UPDATE CHITIETMUONSACH
   SET NGAYTRASH=GETDATE()
   WHERE MACT=@MCT

  
   UPDATE CHITIETMUONSACH
   SET GHICHU=N'Đúng hạng'
   where MACT=@MCT

   DELETE FROM MUONSACH WHERE MAPHIEU=@MCT
  END
  else
   BEGIN
    INSERT INTO CHITIETMUONSACH VALUES(@MCT,@MDG,@MS,@NTS,@GC)
  
    UPDATE SACH
    SET SOLUONG=SOLUONG+1
    WHERE MASH=@MS
   

    UPDATE CHITIETMUONSACH
    SET NGAYTRASH=GETDATE()
    WHERE MACT=@MCT

    UPDATE CHITIETMUONSACH
	SET GHICHU=N'Trễ hạng'
	where MACT=@MCT

	DELETE FROM MUONSACH WHERE MAPHIEU=@MCT
   END
  END

EXEC TRASACH 'MP8','DG01','SH01'

select * from CHITIETMUONSACH
select * from MUONSACH
select * from SACH



